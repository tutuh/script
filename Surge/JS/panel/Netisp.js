/****************
By Keywos  

https://github.com/Keywos/rule/blob/main/JS/Netisp.js

#!name=NetISP é¢æ¿
#!desc=å¯åœ¨å·¥å…·>è„šæœ¬ç¼–è¾‘å™¨>å·¦ä¸‹è§’é½¿è½®å›¾æ ‡>$persistentStoreæ‰¾åˆ° KeyNetisp ä¸­æ›´æ”¹æ˜¯å¦åœ¨é¢æ¿ä¸­æ˜¾ç¤º  å†…ç½‘æˆ–è€…æœ¬æœº true or false
#!system=ios

[Script]
NetISP = type=generic,timeout=8,script-path=https://raw.githubusercontent.com/Keywos/rule/main/JS/Netisp.js

[Panel]
NetISP = script-name=NetISP,update-interval=43200
*****************/

// 2023-09-29 22:48:19
let pro={updata:{"è¯´æ˜Ž":"å¯åœ¨æŒä¹…åŒ–æ•°æ®ä¸­æ›´æ”¹æ˜¯å¦åœ¨é¢æ¿ä¸­æ˜¾ç¤ºè¿™æ ·å¯ä»¥ç›´æŽ¥ä½¿ç”¨è¿œç¨‹é“¾æŽ¥ï¼Œä¸ç”¨æ”¾åœ¨æœ¬åœ°å³å¯ä¿®æ”¹ï¼Œè¾“é”™äº†ä¼šè‡ªåŠ¨æ¢å¤é»˜è®¤é‡æ–°è¿è¡ŒåŽé‡å†™JSONé‡Œçš„å‚æ•°å³å¯","cnTimeout ä¸ºå…¥å£è¶…æ—¶æ—¶é—´":"usTimeout ä¸ºè½åœ°è¶…æ—¶æ—¶é—´","icons ä¸ºå›¾æ ‡":"icolor ä¸ºé¢œè‰²","hideIP ä¸º":"æ˜¯å¦éšè—IP","å¼€ä¸º":true,"å…³ä¸º":false},version:20230922.1,"ä»¥ä¸‹ä¸º":"é…ç½®å‚æ•°",icons:"globe.asia.australia",icolor:"#6699FF",GPT:false,hideIP:true,cnTimeout:1e3,usTimeout:3e3,nw:true},data,updata=true,re=false,ke=false;(async()=>{try{try{let e=$persistentStore.read("KeyNetisp"),t=$environment;data=e?JSON.parse(e):pro;try{!(t["surge-build"]<2867)&&(ke=true);if(data.version<pro.version){data.cnTimeout=pro.cnTimeout;data.usTimeout=pro.usTimeout;data.version=pro.version;console.log("å‡çº§: V"+pro.version);$persistentStore.write(JSON.stringify(data,"",2),"KeyNetisp")}}catch(e){updata=false}if(data.nw||!updata||data.version!==pro.version||typeof data.hideIP!=="boolean"||typeof data.GPT!=="boolean"||typeof data.icons!=="string"||typeof data.icolor!=="string"||typeof data.cnTimeout!=="number"||typeof data.usTimeout!=="number"||typeof data.updata!=="object"){console.log("æ— æ•°æ®æˆ–æ•°æ®é”™è¯¯æˆ–æ›´æ–°,æ¢å¤é»˜è®¤");delete pro.nw;re=true;data=pro}}catch(e){console.log("æ— æ•°æ®æˆ–æ•°æ®é”™è¯¯æˆ–æ›´æ–°,æ¢å¤é»˜è®¤");data=pro;re=true}re&&$persistentStore.write(JSON.stringify(pro,"",2),"KeyNetisp");let e=data.GPT,t=data.icons,o=data.icolor,i=data.hideIP,n=data.cnTimeout,s=data.usTimeout;let a="",r="",l="èŠ‚ç‚¹ä¿¡æ¯æŸ¥è¯¢",c="\n---------------------\nä»£ç†é“¾",u="",p="",d="",f="";const g=await tKey("http://ip-api.com/json/?lang=zh-CN",s);if(g.status==="success"&&ke){console.log("ipapi"+JSON.stringify(g,null,2));let{country:e,countryCode:t,regionName:o,query:n,city:s,org:r,isp:l,as:c,tk:p}=g;a=n;i&&(n=HIP(n));e===s&&(s="");let d=getflag(t)+e+" "+s;u=" \t"+d+"\nè½åœ°IP: \t"+n+": "+p+"ms"+"\nè½åœ°ISP: \t"+l+"\nè½åœ°ASN: \t"+c+""}else{console.log("ild"+JSON.stringify(g));u=""}if(e){const e=await tKey("http://chat.openai.com/cdn-cgi/trace",s);const t=["CN","TW","HK","IR","KP","RU","VE","BY"];if(typeof e!=="string"){let{loc:o,tk:i,warp:n,ip:s}=e,a=t.indexOf(o),r="";if(a==-1){r="GPT: "+o+" âœ“"}else{r="GPT: "+o+" Ã—"}if(n="plus"){n="Plus"}l=r+"       âžŸ     Priv: "+n+"   "+i+"ms"}else{l="ChatGPT "+e}}const m=await httpAPI();let y;const P=m.requests.slice(0,6);let h=P.filter((e=>/ip-api\.com/.test(e.URL)));if(h.length>0&&ke){const e=h[0];f=": "+e.policyName;if(/\(Proxy\)/.test(e.remoteAddress)){y=e.remoteAddress.replace(" (Proxy)","");c=""}else{y=e.remoteAddress}}else{y="Noip"}if($environment["surge-build"]<2867){throw new Error("")}let w=false,k="spe",N=false,T="edtest";isv6=false,cn=true,zl="";if(y==="Noip"){w=true}else if(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(y)){N=true}else if(/^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/.test(y)){isv6=true}if(y==a){cn=false;zl="ç›´è¿žèŠ‚ç‚¹:"}else{zl="è½åœ°åœ°åŒº:";if(!w||N){const e=await tKey(`https://api-v3.${k}${T}.cn/ip?ip=${y}`,n);if(e.code===0&&e.data.country==="ä¸­å›½"){let{province:t,isp:o,city:n,countryCode:s}=e.data,a=e.tk;console.log("ik"+JSON.stringify(e,null,2));cn=true;i&&(y=HIP(y));p="å…¥å£å›½å®¶: \t"+getflag(s)+t+" "+n+"\nå…¥å£IP: \t"+y+": "+a+"ms"+"\nå…¥å£ISP: \t"+o+c+"\n---------------------\n"}else{cn=false;console.log("ik"+JSON.stringify(e));p="å…¥å£IPA Failed\n"}}if((!w||isv6)&&!cn){const e=await tKey(`http://ip-api.com/json/${y}?lang=zh-CN`,s);if(e.status==="success"){console.log("iai"+JSON.stringify(e,null,2));let{countryCode:t,country:o,city:n,tk:s,isp:a}=e;i&&(y=HIP(y));let r=o+" "+n;p="å…¥å£å›½å®¶: \t"+getflag(t)+r+"\nå…¥å£IP: \t"+y+": "+s+"ms"+"\nå…¥å£ISP: \t"+a+c+"\n---------------------\n"}else{console.log("iai"+JSON.stringify(e));p="å…¥å£IPB Failed\n"}}}$done({title:l+f,content:d+r+p+zl+u,icon:t,"icon-color":o})}catch(e){console.log(e.message);$done({title:outgpt+nodeNames,content:local+outbli+outik+outld+zl,icon:icons,"icon-color":icolor})}})(),function e(t,o){if(t.length>o){return t.slice(0,o)}else if(t.length<o){return t.toString().padEnd(o," ")}else{return t}};function sK(e,t){return e.split(" ",t).join(" ").replace(/\.|\,|com|\u4e2d\u56fd/g,"")}function HIP(e){return e.replace(/(\w{1,4})(\.|\:)(\w{1,4})$/,((e,t,o,i)=>`${"âˆ—".repeat(t.length)}.${"âˆ—".repeat(i.length)}`))}async function httpAPI(e="/v1/requests/recent",t="GET",o=null){return new Promise(((i,n)=>{$httpAPI(t,e,o,(e=>{i(e)}))}))}function getflag(e){const t=e.toUpperCase().split("").map((e=>127397+e.charCodeAt()));return String.fromCodePoint(...t).replace(/ðŸ‡¹ðŸ‡¼/g,"ðŸ‡¨ðŸ‡³")}async function tKey(e,t){let o=1,i=1;const s=new Promise(((s,a)=>{const r=async l=>{try{const o=await Promise.race([new Promise(((t,o)=>{let i=Date.now();$httpClient.get({url:e},((e,n,s)=>{if(e){o(e)}else{let e=Date.now()-i;let o=n.status;switch(o){case 200:let o=n.headers["Content-Type"];switch(true){case o.includes("application/json"):let i=JSON.parse(s);i.tk=e;t(i);break;case o.includes("text/html"):t("text/html");break;case o.includes("text/plain"):let n=s.split("\n");let a=n.reduce(((t,o)=>{let[i,n]=o.split("=");t[i]=n;t.tk=e;return t}),{});t(a);break;case o.includes("image/svg+xml"):t("image/svg+xml");break;default:t("æœªçŸ¥");break}break;case 204:let i={tk:e};t(i);break;case 429:console.log("æ¬¡æ•°è¿‡å¤š");t("æ¬¡æ•°è¿‡å¤š");break;case 404:console.log("404");t("404");break;default:t("nokey");break}}}))})),new Promise(((e,o)=>{setTimeout((()=>o(new Error("timeout"))),t)}))]);if(o){s(o)}else{s("è¶…æ—¶");a(new Error(n.message))}}catch(e){if(l<o){i++;r(l+1)}else{s("æ£€æµ‹å¤±è´¥, é‡è¯•æ¬¡æ•°"+i);a(e)}}};r(0)}));return s}